<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="Program">

    <resultMap id="ProgramResult" type="Program">
        <result property="id" column="id_program"/>
        <association property="people" resultMap="PeopleResult"/>
        <association property="family" resultMap="FamilyResult"/>              
        <association property="authorizationType" resultMap="AuthorizationTypeResult"/>
       
    </resultMap>
    
     <resultMap id="PeopleResult" type="People">
        <result property="id" column="id"/>
        <result property="name" column="name"/>  
        <result property="dni" column="dni"/>  
        <result property="active" column="active"/>
    </resultMap>
    
    <resultMap id="FamilyResult" type="Family">
        <result property="id" column="id_family"/>
        <result property="otherInfo" column="other_info_family"/>
        <association property="familyType" resultMap="FamilyTypeResult"/>
        <association property="home" resultMap="HomeResult"/>   

    </resultMap>
    
     
    
    <resultMap id="FamilyTypeResult" type="FamilyType">
        <result property="id" column="id_family_type"/>
        <result property="description" column="description_family_type"/>
    </resultMap>
    
    	<resultMap id="HomeResult" type="Home">
		<result property="id" column="id_home" />
		<result property="regHolding" column="reg_holding" />
		<result property="numberRooms" column="number_rooms" />
		<result property="numberPeople" column="number_people" />
		<result property="numberFamilies" column="number_families" />
		<result property="otherInfo" column="other_info_home" />
		<association property="address" resultMap="AddressResult" />
	</resultMap>
	
	<resultMap id="AddressResult" type="Address">
		<result property="id" column="id_address" />
		<result property="town" column="town" />
		<result property="street" column="street" />
		<result property="gate" column="gate" />
		<result property="floor" column="floor" />
		<result property="telephone" column="telephone" />
		<result property="telephoneContact" column="telephone_contact" />
		<result property="postalCode" column="postal_code" />

	</resultMap>
	
	<resultMap id="AuthorizationTypeResult" type="AuthorizationType">
        <result property="id" column="id_authorization_type"/>
        <result property="description" column="description"/>
    </resultMap>
    
     <select id="findAll" resultMap="ProgramResult">
        SELECT * FROM C_PROGRAM;
    </select>
    
    <select id="findProgram" parameterType="int" resultMap="ProgramResult">
        SELECT PE.DNI, 
               PE.NAME,
               F.ID ID_FAMILY,
               F.OTHER_INFO OTHER_INFO_FAMILY,
               FT.ID ID_FAMILY_TYPE,
               FT.DESCRIPTION DESCRIPTION_FAMILY_TYPE,
               H.ID ID_HOME,
               H.REG_HOLDING,
               H.NUMBER_ROOMS,
               H.NUMBER_PEOPLE,
               H.NUMBER_FAMILIES,
               H.OTHER_INFO OTHER_INFO_HOME,
               A.ID ID_ADDRESS,
               A.TOWN,
               A.STREET,
               A.GATE,
               A.FLOOR,
               A.TELEPHONE,
               A.TELEPHONE_CONTACT,
               A.POSTAL_CODE,
               PR.ID ID_PROGRAM,
               PR.ID_AUTHORIZATION_TYPE
        FROM C_PEOPLE PE, 
              C_PROGRAM PR LEFT JOIN C_AUTHORIZATION_TYPE ATYPE ON   PR.ID_AUTHORIZATION_TYPE = ATYPE.ID,
             C_FAMILY F,
             C_FAMILY_TYPE FT,
             C_HOME H,
             C_ADDRESS A
        WHERE PR.ID_PEOPLE = PE.id
        AND PR.ID_FAMILY = F.ID
        AND F.ID_FAMILY_TYPE = FT.ID
        AND F.ID_HOME = H.ID
        AND H.ID_ADDRESS = A.ID
        AND PE.id = #{id}
    </select>
    
     <delete id="delete" parameterType="People">
    	DELETE FROM C_PROGRAM WHERE id = #{id}
    </delete>
    
    
    <insert id="insert" parameterType="Program" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO C_PROGRAM 
        	(ID_PEOPLE, ID_FAMILY) 
        VALUES (#{people.id}, #{family.id})
    </insert>
    
    <update id="update" parameterType="Program">
        UPDATE C_PROGRAM
        <set>
          <if test="authorizationType.id != null">id_authorization_type = #{authorizationType.id},</if>
          
          </set>
        WHERE id = #{id} 
  	</update>
 	
</mapper>